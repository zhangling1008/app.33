import numpy as np
from sklearn.preprocessing import StandardScaler
from tensorflow.keras.models import Model, load_model
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt
import plotly.graph_objects as go
import streamlit as st
import qrcode
from io import BytesIO
import base64
import socket
import sqlite3
from datetime import datetime
import pandas as pd

import matplotlib.pyplot as plt
import matplotlib.font_manager as fm


# 1. åˆå§‹åŒ–æ•°æ®åº“
def init_db():
    conn = sqlite3.connect('scl90_data.db')
    c = conn.cursor()
    
    # åˆ›å»ºé—®å·ç»“æžœè¡¨
    c.execute('''CREATE TABLE IF NOT EXISTS responses 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  student_id TEXT NOT NULL,
                  timestamp DATETIME,
                  responses TEXT,
                  cluster INTEGER,
                  factor_scores TEXT)''')
    
    # å°è¯•æ·»åŠ åˆ—ï¼ˆå¦‚æžœè¡¨å·²å­˜åœ¨ä½†ç¼ºå°‘è¯¥åˆ—ï¼‰
    try:
        c.execute("ALTER TABLE responses ADD COLUMN student_id TEXT NOT NULL DEFAULT 'unknown'")
    except sqlite3.OperationalError as e:
        # åˆ—å·²å­˜åœ¨æ—¶ä¼šæŠ¥é”™ï¼Œå¯ä»¥å¿½ç•¥
        if "duplicate column name" not in str(e):
            raise
    
    # åˆ é™¤ä¸å†éœ€è¦çš„ç”¨æˆ·ä¿¡æ¯è¡¨
    c.execute("DROP TABLE IF EXISTS user_info")
    
    conn.commit()
    conn.close()
# åˆå§‹åŒ–æ•°æ®åº“
init_db()

# 2. åŠ è½½æ¨¡åž‹å’Œæ•°æ®
@st.cache_resource
def load_models():
    scaler = StandardScaler()
    autoencoder = load_model('scl90_autoencoder.h5')
    embeddings = np.load('embeddings.npy')
    
    # åŠ è½½æ ‡å‡†åŒ–å‚æ•°
    scaler.mean_ = np.load('scaler_mean.npy')
    scaler.scale_ = np.load('scaler_scale.npy')
    
    kmeans = KMeans(n_clusters=3)
    kmeans.fit(embeddings)
    return autoencoder, scaler, kmeans

autoencoder, scaler, kmeans = load_models()


# 4. èŽ·å–æœ¬åœ°IPåœ°å€
def get_local_ip():
    try:
        hostname = socket.gethostname()
        local_ip = socket.gethostbyname(hostname)
        return local_ip
    except:
        return "localhost"

# 5. å®Œæ•´çš„SCL-90é—®å·é¢˜ç›®
questions = [
    "1. å¤´ç—›", "2. ç¥žç»è¿‡æ•ï¼Œå¿ƒä¸­ä¸è¸å®ž", "3. å¤´è„‘ä¸­æœ‰ä¸å¿…è¦çš„æƒ³æ³•æˆ–å­—å¥ç›˜æ—‹", "4. å¤´æ˜æˆ–æ˜å€’", "5. å¯¹å¼‚æ€§å…´è¶£å‡é€€",
    "6. å¯¹æ—äººè´£å¤‡æ±‚å…¨", "7. æ„Ÿåˆ°åˆ«äººèƒ½æŽ§åˆ¶æ‚¨çš„æ€æƒ³", "8. è´£æ€ªä»–äººåˆ¶é€ éº»çƒ¦", "9. å¿˜è®°æ€§å¤§", 
    "10. æ‹…å¿ƒè‡ªå·±çš„è¡£é¥°æ•´é½ä»¥åŠä»ªæ€ç«¯æ­£", "11. æ˜“çƒ¦æ¼æ¿€åŠ¨", "12. èƒ¸ç—›", "13. å®³æ€•ç©ºæ—·åœºæ‰€æˆ–è¡—é“",
    "14. æ„Ÿåˆ°è‡ªå·±ç²¾åŠ›ä¸‹é™ï¼Œæ´»åŠ¨å‡æ…¢", "15. æƒ³ç»“æŸè‡ªå·±çš„ç”Ÿå‘½", "16. å¬åˆ°æ—äººå¬ä¸åˆ°çš„å£°éŸ³", "17. å‘æŠ–", "18. æ„Ÿåˆ°å¤§å¤šæ•°äººéƒ½ä¸å¯ä¿¡ä»»",
    "19. èƒƒå£å·®", "20. å®¹æ˜“å“­æ³£", "21. ä¸Žå¼‚æ€§ç›¸å¤„å®³ç¾žä¸è‡ªåœ¨", "22. æ„Ÿåˆ°å—éª—ã€ä¸­äº†åœˆå¥—æˆ–æœ‰äººæƒ³æŠ“ä½æ‚¨", 
    "23. æ— ç¼˜æ— æ•…åœ°æ„Ÿåˆ°å®³æ€•", "24.è‡ªå·±ä¸èƒ½æŽ§åˆ¶åœ°å¤§å‘è„¾æ°”", "25. æ€•å•ç‹¬å‡ºé—¨", "26. ç»å¸¸è´£æ€ªè‡ªå·±",
    "27. è…°ç—›", "28. æ„Ÿåˆ°éš¾ä»¥å®Œæˆä»»åŠ¡", "29. æ„Ÿåˆ°å­¤ç‹¬", "30. æ„Ÿåˆ°è‹¦é—·", "31. è¿‡åˆ†æ‹…å¿§",
    "32. å¯¹äº‹ç‰©ä¸æ„Ÿå…´è¶£", "33. æ„Ÿåˆ°å®³æ€•", "34. æ‚¨çš„æ„Ÿæƒ…æ˜“å—ä¼¤å®³", "35. æ—äººçŸ¥é“è‡ªå·±çš„ç§ä¸‹æƒ³æ³•",
    "36. æ„Ÿåˆ°åˆ«äººä¸ç†è§£æ‚¨ä¸åŒæƒ…æ‚¨","37. æ„Ÿåˆ°äººä»¬å¯¹æ‚¨ä¸å‹å¥½ï¼Œä¸å–œæ¬¢æ‚¨", "38. åšäº‹å¿…é¡»åšå¾—å¾ˆæ…¢ä»¥ä¿è¯åšå¾—æ­£ç¡®", "39. å¿ƒè·³å¾—å¾ˆåŽ‰å®³",
    "40. æ¶å¿ƒæˆ–èƒƒéƒ¨ä¸é€‚", "41. æ„Ÿåˆ°æ¯”ä¸ä¸Šä»–äºº", "42. è‚Œè‚‰é…¸ç—›", "43.æ„Ÿè§‰æœ‰äººåœ¨ç›‘è§†æ‚¨è°ˆè®ºä½ ",
    "44. å…¥ç¡å›°éš¾", "45. åšäº‹å¿…é¡»åå¤æ£€æŸ¥", "46. éš¾ä»¥ä½œå‡ºå†³å®š", "47. æ€•ä¹˜ç”µè½¦ã€å…¬å…±æ±½è½¦ã€åœ°é“æˆ–ç«è½¦",
    "48. å‘¼å¸å›°éš¾", "49. ä¸€é˜µé˜µå‘å†·æˆ–å‘çƒ­", "50.å› ä¸ºæ„Ÿåˆ°å®³æ€•è€Œé¿å¼€æŸäº›ä¸œè¥¿ã€åœºåˆæˆ–æ´»åŠ¨", "51. è„‘å­å˜ç©º",
    "52. èº«ä½“å‘éº»æˆ–åˆºç—›", "53. å–‰å’™æœ‰æ¢—å¡žæ„Ÿ", "54. æ„Ÿè§‰å‰é€”æ²¡æœ‰å¸Œæœ›", "55. ä¸èƒ½é›†ä¸­æ³¨æ„",
    "56. æ„Ÿåˆ°èº«ä½“çš„æŸä¸€éƒ¨åˆ†è½¯å¼±æ— åŠ›", "57. æ„Ÿåˆ°ç´§å¼ æˆ–å®¹æ˜“ç´§å¼ ", "58. æ„Ÿåˆ°æ‰‹æˆ–è„šå‘é‡", "59. æƒ³åˆ°æ­»äº¡çš„äº‹æƒ…",
    "60. åƒå¾—å¤ªå¤š", "61. å½“åˆ«äººçœ‹ç€æ‚¨æˆ–è°ˆè®ºæ‚¨æ—¶æ„Ÿåˆ°ä¸è‡ªåœ¨", "62. æœ‰ä¸€äº›ä¸å±žäºŽæ‚¨è‡ªå·±çš„æƒ³æ³•", 
    "63. æœ‰æƒ³æ‰“äººæˆ–ä¼¤å®³ä»–äººå†²åŠ¨", "64. é†’å¾—å¤ªæ—©", "65. å¿…é¡»åå¤æ´—æ‰‹ï¼Œç‚¹æ•°ç›®æˆ–è§¦æ‘¸æŸäº›ä¸œè¥¿", "66. ç¡å¾—ä¸ç¨³ä¸é†’",
    "67. æœ‰æƒ³æ‘”åæˆ–ç ´åä¸œè¥¿çš„å†²åŠ¨", "68. æœ‰ä¸€äº›åˆ«äººæ²¡æœ‰çš„æƒ³æ³•æˆ–å¿µå¤´", "69. æ„Ÿåˆ°å¯¹åˆ«äººç¥žç»è¿‡æ•", "70. åœ¨å•†åº—æˆ–ç”µå½±é™¢ç­‰äººå¤šçš„åœ°æ–¹æ„Ÿåˆ°ä¸è‡ªåœ¨",
    "71. æ„Ÿåˆ°ä»»ä½•äº‹æƒ…éƒ½å¾ˆå›°éš¾", "72. ä¸€é˜µé˜µææƒ§æˆ–æƒŠæ…Œ", "73. æ„Ÿåˆ°åœ¨å…¬å…±åœºåˆåƒä¸œè¥¿å¾ˆä¸èˆ’æœé£Ÿä¸é€‚", "74. ç»å¸¸ä¸Žäººäº‰è®º",
    "75. å•ç‹¬ä¸€äººæ—¶ç¥žç»å¾ˆç´§å¼ ", "76. åˆ«äººå¯¹æ‚¨çš„æˆç»©æ²¡æœ‰åšå‡ºæ°å½“çš„è¯„ä»·", "77. å³ä½¿å’Œåˆ«äººåœ¨ä¸€èµ·ä¹Ÿæ„Ÿåˆ°å­¤ç‹¬", "78. æ„Ÿåˆ°åç«‹ä¸å®‰å¿ƒç¥žä¸å®š",
    "79. æ„Ÿåˆ°è‡ªå·±æ²¡æœ‰ä»€ä¹ˆä»·å€¼", "80. æ„Ÿåˆ°ç†Ÿæ‚‰çš„ä¸œè¥¿å˜å¾—é™Œç”Ÿæˆ–ä¸åƒæ˜¯çœŸçš„", "81. å¤§å«æˆ–æ‘”ä¸œè¥¿", "82. å®³æ€•ä¼šåœ¨å…¬å…±åœºåˆæ˜å€’",
    "83. æ„Ÿåˆ°åˆ«äººæƒ³å æ‚¨çš„ä¾¿å®œ", "84. ä¸ºä¸€äº›æœ‰å…³â€œæ€§â€çš„æƒ³æ³•è€Œå¾ˆè‹¦æ¼", "85. æ‚¨è®¤ä¸ºåº”è¯¥å› ä¸ºè‡ªå·±çš„è¿‡é”™è€Œå—åˆ°æƒ©ç½š", "86. æ„Ÿåˆ°è¦èµ¶å¿«æŠŠäº‹æƒ…åšå®Œ",
    "87. æ„Ÿè§‰èº«ä½“æœ‰ä¸¥é‡é—®é¢˜", "88. ä»Žæœªæ„Ÿåˆ°å’Œå…¶ä»–äººå¾ˆäº²è¿‘", "89. æ„Ÿåˆ°è‡ªå·±æœ‰ç½ª", "90. æ„Ÿè§‰è‡ªå·±è„‘å­æœ‰æ¯›ç—…"
]

# 6. ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
def save_to_db(student_id, responses, cluster, factor_scores):
    conn = sqlite3.connect('scl90_data.db')
    c = conn.cursor()
    
    # ä¿å­˜é—®å·ç»“æžœ
    c.execute('''INSERT INTO responses 
                 (student_id, timestamp, responses, cluster, factor_scores) 
                 VALUES (?, ?, ?, ?, ?)''',
              (student_id,
               datetime.now(), 
               str(responses), 
               int(cluster), 
               str(factor_scores)))
    
    conn.commit()
    conn.close()
# 7. åˆ›å»ºé—®å·ç•Œé¢
st.title("SCL-90å¿ƒç†å¥åº·è‡ªè¯„é‡è¡¨")

with st.sidebar:
    # ç®¡ç†å‘˜ç™»å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    st.subheader("ç®¡ç†å‘˜ç™»å½•")
    admin_pass = st.text_input("å¯†ç ", type="password", key="admin_pass")
    
    # æ·»åŠ æ˜Žç¡®çš„ç™»å½•æŒ‰é’®
    login_button = st.button("ç™»å½•")
    logout_button = st.button("æ³¨é”€") if 'admin' in st.session_state else None
    
    if login_button:
        if admin_pass == "admin123":  # ç®€å•å¯†ç ï¼Œå®žé™…ä½¿ç”¨ä¸­åº”è¯¥æ›´å®‰å…¨
            st.session_state.admin = True
            st.success("ç®¡ç†å‘˜æ¨¡å¼å·²æ¿€æ´»")
        else:
            st.error("å¯†ç é”™è¯¯")
    
    if logout_button:
        del st.session_state.admin
        st.success("å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼")

# ä¸»é—®å·åŒºåŸŸ
with st.form("scl90_form"):
    # å­¦å·è¾“å…¥
    student_id = st.text_input("å­¦å·*", help="è¯·è¾“å…¥æ‚¨çš„å­¦å·", key="student_id")
    
    st.subheader("è¯·æ ¹æ®æœ€è¿‘ä¸€å‘¨çš„æ„Ÿè§‰è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ï¼š")
    st.caption("1=æ²¡æœ‰ï¼Œ2=å¾ˆè½»ï¼Œ3=ä¸­ç­‰ï¼Œ4=åé‡ï¼Œ5=ä¸¥é‡")
    
    responses = []
    cols = st.columns(5)  # åˆ†5åˆ—æ˜¾ç¤º
    for i, q in enumerate(questions):
        with cols[i % 5]:
            responses.append(
                st.radio(
                    q,
                    options=[1, 2, 3, 4, 5],
                    horizontal=True,
                    key=f"q{i}"
                )
            )
    
    submitted = st.form_submit_button("æäº¤è¯„ä¼°")
    
    if submitted:
        if not student_id:
            st.error("è¯·è¾“å…¥å­¦å·")
        elif len(responses) != 90:
            st.error("è¯·ç¡®ä¿å›žç­”äº†æ‰€æœ‰90ä¸ªé—®é¢˜")
        else:
            try:
                # è®¡ç®—å› å­å¾—åˆ†
                factors = {
                    'èº¯ä½“åŒ–': [0,3,11,26,39,41,47,48,51,52,55,57],
                    'å¼ºè¿«ç—‡çŠ¶': [2,8,9,27,37,44,45,50,54,64],
                    'äººé™…å…³ç³»æ•æ„Ÿ': [5,20,33,35,36,40,60,68,72],
                    'æŠ‘éƒ': [4,13,14,19,21,25,28,29,30,31,53,70,78],
                    'ç„¦è™‘': [1,16,22,32,38,56,71,77,79,85],
                    'æ•Œå¯¹': [10,23,62,66,73,80],
                    'ææ€–': [12,24,46,49,69,74,81],
                    'åæ‰§': [7,17,42,67,75,82],
                    'ç²¾ç¥žç—…æ€§': [6,15,34,61,76,83,84,86,87,89],
                    'å…¶ä»–': [18,43,58,59,63,65,88]
                }
                
                # éªŒè¯ç´¢å¼•èŒƒå›´
                for factor, indices in factors.items():
                    for idx in indices:
                        if idx >= len(responses):
                            raise IndexError(f"å› å­'{factor}'çš„ç´¢å¼•{idx}è¶…å‡ºèŒƒå›´")
                
                factor_scores = []
                for factor, indices in factors.items():
                    score = np.mean([responses[i] for i in indices])
                    factor_scores.append(score)
                
                # åˆ†ç±»é¢„æµ‹
                scaled = scaler.transform(np.array(factor_scores).reshape(1, -1))
                encoder = Model(inputs=autoencoder.input, outputs=autoencoder.layers[1].output)
                embedding = encoder.predict(scaled, verbose=0)
                cluster = kmeans.predict(embedding)[0]
                
                # ä¿å­˜åˆ°æ•°æ®åº“
                save_to_db(student_id, responses, cluster, factor_scores)
                
                # æ˜¾ç¤ºç»“æžœ
                st.success("è¯„ä¼°å®Œæˆï¼")
                st.info(f"æ‚¨çš„å­¦å·: {student_id} (è¯·å¦¥å–„ä¿å­˜)")
                
                descriptions = {
                    0: "æ‚¨çš„å¿ƒç†å¥åº·çŠ¶å†µè‰¯å¥½",
                    1: "å­˜åœ¨è½»åº¦å¿ƒç†å›°æ‰°",
                    2: "å»ºè®®å¯»æ±‚ä¸“ä¸šå¿ƒç†å¸®åŠ©"
                }
                
                st.write(f"**è¯„ä¼°ç»“æžœ**: {descriptions.get(cluster, 'æœªçŸ¥çŠ¶æ€')}")
                
                st.subheader("å› å­å¾—åˆ†é›·è¾¾å›¾")
                # å‡†å¤‡é›·è¾¾å›¾æ•°æ®
                categories = list(factors.keys())
                values = factor_scores
                
                fig = go.Figure()
                
                fig.add_trace(go.Scatterpolar(
                    r=values,
                    theta=categories,
                    fill='toself',
                    name='å› å­å¾—åˆ†'
                ))
                
                fig.update_layout(
                    polar=dict(
                        radialaxis=dict(
                            visible=True,
                            range=[0, 5]  # SCL-90è¯„åˆ†èŒƒå›´æ˜¯1-5
                        )),
                    showlegend=True,
                    title="SCL-90å„å› å­å¾—åˆ†é›·è¾¾å›¾"
                )
                
                st.plotly_chart(fig)
                
                # æ˜¾ç¤ºå› å­å¾—åˆ†è¡¨æ ¼
                st.subheader("å„å› å­å¾—åˆ†è¯¦æƒ…")
                factor_data = {
                    "å› å­åç§°": categories,
                    "å¹³å‡å¾—åˆ†": [f"{score:.2f}" for score in values],
                    "è§£é‡Š": [
                        "èº«ä½“ä¸é€‚æ„Ÿ" if score > 2.5 else "æ­£å¸¸" if score < 1.5 else "è½»å¾®ä¸é€‚"
                        for score in values
                    ]
                }
                st.table(pd.DataFrame(factor_data))
                
               
                st.subheader("ä¸ªæ€§åŒ–å»ºè®®")
                
                cluster_advice = {
                            0: [
                                "ðŸŽ¯ ç»´æŒè‰¯å¥½çŠ¶æ€å»ºè®®ï¼š",
                                "â€¢ ç»§ç»­ä¿æŒå½“å‰å¥åº·çš„ç”Ÿæ´»æ–¹å¼æ¨¡å¼ï¼Œæ¯å‘¨ä¿æŒ3-5æ¬¡ã€æ¯æ¬¡30åˆ†é’Ÿçš„ä¸­ç­‰å¼ºåº¦è¿åŠ¨",
                                "â€¢ å»ºè®®æ¯3-6ä¸ªæœˆè¿›è¡Œä¸€æ¬¡å¿ƒç†å¥åº·è‡ªè¯„ï¼Œå¯ä½¿ç”¨PHQ-9æˆ–GAD-7ç­‰ç®€æ˜“é‡è¡¨",
                                "â€¢ å»ºç«‹è§„å¾‹ä½œæ¯ï¼ˆå»ºè®®ç¡çœ æ—¶é—´22:30-6:30ï¼‰ï¼Œä¿è¯7-8å°æ—¶ä¼˜è´¨ç¡çœ ",
                                "â€¢ å¯å°è¯•æ­£å¿µå†¥æƒ³ç­‰é¢„é˜²æ€§å¿ƒç†è®­ç»ƒï¼ŒæŽ¨èä½¿ç”¨'Headspace'æˆ–'æ½®æ±'ç­‰APP",
                                "",
                                "ðŸ“ˆ æå‡å»ºè®®ï¼š",
                                "â€¢ å‚åŠ å¿ƒç†å¥åº·çŸ¥è¯†è®²åº§ï¼Œæå‡å¿ƒç†éŸ§æ€§",
                                "â€¢ åŸ¹å…»1-2ä¸ªå‡åŽ‹çˆ±å¥½ï¼ˆå¦‚ç»˜ç”»ã€å›­è‰ºç­‰ï¼‰"
                            ],
                            1: [
                                "âš ï¸ é‡ç‚¹å…³æ³¨é¢†åŸŸï¼š",
                                "â€¢ æ‚¨çš„è¯„ä¼°æ˜¾ç¤ºåœ¨[æŠ‘éƒ/ç„¦è™‘]ç»´åº¦å­˜åœ¨è½»åº¦å›°æ‰°ï¼ˆå¾—åˆ†2.8ï¼Œå¸¸æ¨¡1.2-1.8ï¼‰",
                                "â€¢ è¿™äº›ç—‡çŠ¶å¯èƒ½è¡¨çŽ°ä¸ºï¼šæƒ…ç»ªæ³¢åŠ¨å¢žå¤§ã€ç¡çœ è´¨é‡ä¸‹é™ã€æ³¨æ„åŠ›éš¾ä»¥é›†ä¸­ç­‰æƒ…å†µ",
                                "",
                                "ðŸ› ï¸ è‡ªåŠ©æ”¹å–„æ–¹æ¡ˆï¼š",
                                "â€¢ æƒ…ç»ªç®¡ç†ï¼šæ¯å¤©è®°å½•'ä¸‰ä»¶å¥½äº‹'æ—¥è®°ï¼ŒåŸ¹å…»ç§¯æžè®¤çŸ¥æ¨¡å¼",
                                "â€¢ æ”¾æ¾è®­ç»ƒï¼šæ¯å¤©2æ¬¡'4-7-8å‘¼å¸æ³•'ï¼ˆå¸æ°”4ç§’-å±æ¯7ç§’-å‘¼æ°”8ç§’ï¼‰",
                                "â€¢ è¡Œä¸ºæ¿€æ´»ï¼šåˆ¶å®šæ¯æ—¥å°ç›®æ ‡ï¼ˆå¦‚æ•£æ­¥15åˆ†é’Ÿã€è”ç³»1ä½æœ‹å‹ï¼‰",
                                "â€¢ ç¡çœ æ”¹å–„ï¼šå»ºç«‹ç¡å‰1å°æ—¶'æ•°å­—æˆ’æ–­'ä¹ æƒ¯ï¼Œä¿æŒå§å®¤æ¸©åº¦18-22â„ƒ",
                                "",
                                "ðŸ‘¨â€âš•ï¸ ä¸“ä¸šæ”¯æŒå»ºè®®ï¼š",
                                "â€¢ å¦‚æžœä¸Šè¿°ç—‡çŠ¶æŒç»­2å‘¨ä»¥ä¸Šæœªè§æ”¹å–„ï¼Œå»ºè®®é¢„çº¦å¿ƒç†å’¨è¯¢",
                                "â€¢ å¯å…ˆä½¿ç”¨æ ¡å¿ƒç†ä¸­å¿ƒæä¾›çš„'å¿ƒç†è‡ªåŠ©èµ„æºåŒ…'ï¼ˆåŒ…å«æ”¾æ¾æŒ‡å¯¼éŸ³é¢‘ç­‰ï¼‰",
                                "â€¢ æŽ¨èé˜…è¯»ï¼šã€Šæ”¹å–„æƒ…ç»ªçš„æ­£å¿µç–—æ³•ã€‹ï¼ˆWilliamsè‘—ï¼‰"
                            ],
                            2: [
                                "ðŸš¨ é‡è¦æç¤ºï¼š",
                                "â€¢ æ‚¨çš„è¯„ä¼°ç»“æžœæ˜¾ç¤ºå¤šä¸ªç»´åº¦ï¼ˆæŠ‘éƒã€ç„¦è™‘ç­‰ï¼‰æ˜¾è‘—é«˜äºŽå¸¸æ¨¡æ°´å¹³",
                                "â€¢ è¿™äº›ç—‡çŠ¶å¯èƒ½å·²ç»å½±å“åˆ°æ‚¨çš„å­¦ä¹ æ•ˆçŽ‡ã€ç¤¾äº¤åŠŸèƒ½å’Œæ—¥å¸¸ç”Ÿæ´»è´¨é‡",
                                "",
                                "âš¡ ç«‹å³è¡ŒåŠ¨å»ºè®®ï¼š",
                                "1. å®‰å…¨è®¡åˆ’ï¼š",
                                "   - è¯†åˆ«3ä¸ªå¯ä»¥éšæ—¶è”ç³»çš„æ”¯æŒäººå‘˜ï¼ˆäº²å‹/è¾…å¯¼å‘˜ç­‰ï¼‰",
                                "   - ä¿å­˜å¿ƒç†å±æœºå¹²é¢„çƒ­çº¿ï¼ˆåŒ—äº¬å¿ƒç†å±æœºå¹²é¢„ä¸­å¿ƒ010-82951332ï¼‰",
                                "2. ä¸“ä¸šå¸®åŠ©ï¼š",
                                "   - å»ºè®®3å¤©å†…é¢„çº¦å¿ƒç†å’¨è¯¢å¸ˆè¿›è¡Œä¸“ä¸šè¯„ä¼°",
                                "   - å¯è”ç³»æ ¡åŒ»é™¢ç²¾ç¥žç§‘æˆ–å½“åœ°ä¸“ç§‘åŒ»é™¢å¿ƒç†é—¨è¯Š",
                                "3. è‡ªæˆ‘ç…§é¡¾ï¼š",
                                "   - é¿å…ç‹¬å¤„äºŽé«˜é£Žé™©çŽ¯å¢ƒï¼ˆå¦‚é«˜å¤„ã€å±é™©ç‰©å“é™„è¿‘ï¼‰",
                                "   - ä¿æŒåŸºç¡€ç”Ÿæ´»èŠ‚å¾‹ï¼ˆè‡³å°‘ä¿è¯1æ—¥3é¤ã€4å°æ—¶ç¡çœ ï¼‰",
                                "",
                                "ðŸ¥ æ²»ç–—é€‰æ‹©å‚è€ƒï¼š",
                                "â€¢ å¿ƒç†å’¨è¯¢ï¼šè®¤çŸ¥è¡Œä¸ºæ²»ç–—ï¼ˆCBTï¼‰æˆ–æŽ¥çº³æ‰¿è¯ºæ²»ç–—ï¼ˆACTï¼‰",
                                "â€¢ å¿…è¦æ—¶å¯è€ƒè™‘è¯ç‰©è¾…åŠ©æ²»ç–—ï¼ˆéœ€ä¸“ä¸šåŒ»ç”Ÿè¯„ä¼°ï¼‰",
                                "â€¢ å›¢ä½“æ²»ç–—ï¼šæ ¡å¿ƒç†ä¸­å¿ƒå¯èƒ½æä¾›ç›¸å…³æ”¯æŒå°ç»„",
                                "",
                                "ðŸ“Œ æ³¨æ„äº‹é¡¹ï¼š",
                                "â€¢ é¿å…ä½¿ç”¨é…’ç²¾æˆ–ä¸è§„èŒƒè¯ç‰©è‡ªæˆ‘æ²»ç–—",
                                "â€¢ æš‚æ—¶å‡å°‘é‡å¤§å†³å®šï¼ˆå¦‚ä¼‘å­¦ã€åˆ†æ‰‹ç­‰ï¼‰",
                                "â€¢ ç—‡çŠ¶ç¼“è§£åŽä»éœ€ç»´æŒ4-8å‘¨çš„å·©å›ºæœŸ"
                            ]
                        }
                for advice in cluster_advice.get(cluster, cluster_advice[2]):
                    st.markdown(f"- {advice}")
                
            except Exception as e:
                st.error(f"å¤„ç†å‡ºé”™: {str(e)}")
                st.info("è¯·ç¡®ä¿å·²å›žç­”æ‰€æœ‰é—®é¢˜å¹¶é‡æ–°æäº¤")

# ç®¡ç†å‘˜æ•°æ®æŸ¥çœ‹
if 'admin' in st.session_state and st.session_state.admin:
    conn = sqlite3.connect('scl90_data.db')
    df = pd.read_sql('SELECT * FROM responses', conn)
    conn.close()
    
    st.subheader("æ‰€æœ‰é—®å·æ•°æ®")
    st.dataframe(df)
    
    # æ·»åŠ æ•°æ®åˆ†æžåŠŸèƒ½
    st.subheader("æ•°æ®åˆ†æž")
    if not df.empty:
        st.write(f"æ€»æ”¶é›†é‡: {len(df)}")
        st.bar_chart(df['cluster'].value_counts())
        
        # å¯¼å‡ºæ•°æ®
        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button(
            "å¯¼å‡ºæ•°æ®ä¸ºCSV",
            data=csv,
            file_name='scl90_responses.csv',
            mime='text/csv'
        )